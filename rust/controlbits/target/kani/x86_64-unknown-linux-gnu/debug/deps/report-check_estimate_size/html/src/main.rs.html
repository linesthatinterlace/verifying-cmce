
<html>
<head>
<title>src/main.rs</title>
<link rel="stylesheet" type="text/css" href="../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 #![deny(clippy::pedantic)]</div><div id="2" class="line none">    2 #![allow(clippy::many_single_char_names)]</div><div id="3" class="line none">    3 use simple_error::SimpleError;</div><div id="4" class="line none">    4 use std::cmp::min;</div><div id="5" class="line none">    5 use std::iter::zip;</div><div id="6" class="line none">    6 </div><div id="7" class="line none">    7 fn <a href="main.rs.html#7">get_permutation_length</a>(pi: &amp;[usize]) -&gt; <a href="main.rs.html#7">Result</a>&lt;usize, SimpleError&gt; {</div><div id="8" class="line none">    8     let n = pi.len();</div><div id="9" class="line none">    9     if pi.iter().any(|&amp;x| n &lt;= x) {</div><div id="10" class="line none">   10         Err(SimpleError::new("Permutation value out of bounds"))</div><div id="11" class="line none">   11     } else if pi.iter().enumerate().any(|(i, p)| pi[i..].contains(p)) {</div><div id="12" class="line none">   12         Ok(n)</div><div id="13" class="line none">   13     } else {</div><div id="14" class="line none">   14         Err(SimpleError::new("Permutation contains repeated values"))</div><div id="15" class="line none">   15     }</div><div id="16" class="line none">   16 }</div><div id="17" class="line none">   17 </div><div id="18" class="line none">   18 fn get_permutation_exponent(pi: &amp;[usize]) -&gt; <a href="main.rs.html#7">Result</a>&lt;usize, SimpleError&gt; {</div><div id="19" class="line none">   19     let n = <a href="main.rs.html#7">get_permutation_length</a>(pi)?;</div><div id="20" class="line none">   20     if let Some(<a href="main.rs.html#49">m</a>) = n.checked_ilog2() {</div><div id="21" class="line none">   21         if let Ok(<a href="main.rs.html#49">m</a>) = usize::try_from(<a href="main.rs.html#49">m</a>) {</div><div id="22" class="line none">   22             if 1 &lt;&lt; <a href="main.rs.html#49">m</a> == n {</div><div id="23" class="line none">   23                 Ok(<a href="main.rs.html#49">m</a>)</div><div id="24" class="line none">   24             } else {</div><div id="25" class="line none">   25                 Err(SimpleError::new("Length not a power of two"))</div><div id="26" class="line none">   26             }</div><div id="27" class="line none">   27         } else {</div><div id="28" class="line none">   28             Err(SimpleError::new("Length exponent will not fit into usize"))</div><div id="29" class="line none">   29         }</div><div id="30" class="line none">   30     } else {</div><div id="31" class="line none">   31         Err(SimpleError::new("Length is zero"))</div><div id="32" class="line none">   32     }</div><div id="33" class="line none">   33 }</div><div id="34" class="line none">   34 </div><div id="35" class="line none">   35 fn get_controlbits_exponent(c: &amp;[bool]) -&gt; <a href="main.rs.html#7">Result</a>&lt;usize, SimpleError&gt; {</div><div id="36" class="line none">   36     let mut <a href="main.rs.html#49">m</a> = 1;</div><div id="37" class="line none">   37     let l = c.len();</div><div id="38" class="line none">   38     while (2 * <a href="main.rs.html#49">m</a> - 1) &lt;&lt; (<a href="main.rs.html#49">m</a> - 1) &lt; l {</div><div id="39" class="line none">   39         <a href="main.rs.html#49">m</a> += 1;</div><div id="40" class="line none">   40     }</div><div id="41" class="line none">   41     if (2 * <a href="main.rs.html#49">m</a> - 1) &lt;&lt; (<a href="main.rs.html#49">m</a> - 1) == l {</div><div id="42" class="line none">   42         Ok(<a href="main.rs.html#49">m</a>)</div><div id="43" class="line none">   43     } else {</div><div id="44" class="line none">   44         Err(SimpleError::new("Length invalid"))</div><div id="45" class="line none">   45     }</div><div id="46" class="line none">   46 }</div><div id="47" class="line none">   47 </div><div id="48" class="line none">   48 fn permute_using&lt;T&gt;(a: &amp;mut [T], c: &amp;[bool]) -&gt; <a href="main.rs.html#7">Result</a>&lt;(), SimpleError&gt; {</div><div id="49" class="line none">   49     let <a href="main.rs.html#49">m</a> = get_controlbits_exponent(c)?;</div><div id="50" class="line none">   50     let <a href="main.rs.html#50">gaps</a> = (0..<a href="main.rs.html#49">m</a>).chain((0..(<a href="main.rs.html#49">m</a> - 1)).rev());</div><div id="51" class="line none">   51     for (ch, gap) in c.chunks(1 &lt;&lt; (<a href="main.rs.html#49">m</a> - 1)).zip(<a href="main.rs.html#50">gaps</a>) {</div><div id="52" class="line none">   52         for (j, &amp;b) in ch.iter().enumerate() {</div><div id="53" class="line none">   53             if b {</div><div id="54" class="line none">   54                 let pos: usize = j + ((j &gt;&gt; gap) &lt;&lt; gap);</div><div id="55" class="line none">   55                 a.swap(pos, pos + (1 &lt;&lt; gap));</div><div id="56" class="line none">   56             }</div><div id="57" class="line none">   57         }</div><div id="58" class="line none">   58     }</div><div id="59" class="line none">   59     Ok(())</div><div id="60" class="line none">   60 }</div><div id="61" class="line none">   61 </div><div id="62" class="line none">   62 fn permutation(c: &amp;[bool]) -&gt; <a href="main.rs.html#7">Result</a>&lt;<a href="main.rs.html#114">Vec</a>&lt;usize&gt;, SimpleError&gt; {</div><div id="63" class="line none">   63     let <a href="main.rs.html#49">m</a> = get_controlbits_exponent(c)?;</div><div id="64" class="line none">   64     let mut pi: <a href="main.rs.html#114">Vec</a>&lt;_&gt; = (0..(1 &lt;&lt; <a href="main.rs.html#49">m</a>)).collect();</div><div id="65" class="line none">   65     permute_using(&amp;mut pi, c)?;</div><div id="66" class="line none">   66     Ok(pi)</div><div id="67" class="line none">   67 }</div><div id="68" class="line none">   68 </div><div id="69" class="line none">   69 fn composeinv&lt;T: Copy&gt;(c: &amp;[T], pi: &amp;[usize]) -&gt; <a href="main.rs.html#7">Result</a>&lt;<a href="main.rs.html#114">Vec</a>&lt;T&gt;, SimpleError&gt; {</div><div id="70" class="line none">   70     let n = <a href="main.rs.html#7">get_permutation_length</a>(pi)?;</div><div id="71" class="line none">   71     if n == c.len() {</div><div id="72" class="line none">   72         let mut s: <a href="main.rs.html#114">Vec</a>&lt;_&gt; = pi.iter().zip(c.iter()).collect();</div><div id="73" class="line none">   73         s.sort_unstable_by_key(|(&amp;a, _)| a);</div><div id="74" class="line none">   74         let k: <a href="main.rs.html#114">Vec</a>&lt;T&gt; = s.into_iter().map(|(_, &amp;b)| b).collect();</div><div id="75" class="line none">   75         Ok(k)</div><div id="76" class="line none">   76     } else {</div><div id="77" class="line none">   77         Err(SimpleError::new(</div><div id="78" class="line none">   78             "Permutation length does not match length of permuted vector",</div><div id="79" class="line none">   79         ))</div><div id="80" class="line none">   80     }</div><div id="81" class="line none">   81 }</div><div id="82" class="line none">   82 </div><div id="83" class="line none">   83 fn composeinv_nc&lt;T: Copy&gt;(c: &amp;[T], pi: &amp;[usize]) -&gt; <a href="main.rs.html#7">Result</a>&lt;<a href="main.rs.html#114">Vec</a>&lt;T&gt;, SimpleError&gt; {</div><div id="84" class="line none">   84     let n = <a href="main.rs.html#7">get_permutation_length</a>(pi)?;</div><div id="85" class="line none">   85     if n != c.len() {</div><div id="86" class="line none">   86         return Err(SimpleError::new(</div><div id="87" class="line none">   87             "Permutation length does not match length of permuted vector",</div><div id="88" class="line none">   88         ));</div><div id="89" class="line none">   89     }</div><div id="90" class="line none">   90 </div><div id="91" class="line none">   91     let s: <a href="main.rs.html#114">Vec</a>&lt;T&gt; = pi.iter().map(|&amp;i| c[i]).collect();</div><div id="92" class="line none">   92     Ok(s)</div><div id="93" class="line none">   93 }</div><div id="94" class="line none">   94 </div><div id="95" class="line none">   95 fn cyclemin_pibar(pi: &amp;[usize]) -&gt; <a href="main.rs.html#7">Result</a>&lt;<a href="main.rs.html#114">Vec</a>&lt;usize&gt;, SimpleError&gt; {</div><div id="96" class="line none">   96     let <a href="main.rs.html#49">m</a> = get_permutation_exponent(pi)?;</div><div id="97" class="line none">   97     let mut pi_xor = pi.to_vec();</div><div id="98" class="line none">   98     for pair in pi_xor.chunks_exact_mut(2) {</div><div id="99" class="line none">   99         pair.swap(0, 1);</div><div id="100" class="line none">  100     }</div><div id="101" class="line none">  101     let mut xor_pi: <a href="main.rs.html#114">Vec</a>&lt;_&gt; = pi.iter().map(|&amp;x| x ^ 1).collect();</div><div id="102" class="line none">  102     let mut c: <a href="main.rs.html#114">Vec</a>&lt;_&gt; = (0..(1 &lt;&lt; <a href="main.rs.html#49">m</a>)).collect();</div><div id="103" class="line none">  103 </div><div id="104" class="line none">  104     for _ in 0..<a href="main.rs.html#49">m</a> {</div><div id="105" class="line none">  105         let pi_xor_copy = composeinv(&amp;pi_xor, &amp;xor_pi)?;</div><div id="106" class="line none">  106         xor_pi = composeinv_nc(&amp;xor_pi, &amp;pi_xor)?;</div><div id="107" class="line none">  107         pi_xor = pi_xor_copy;</div><div id="108" class="line none">  108         let cp = composeinv(&amp;c, &amp;xor_pi)?;</div><div id="109" class="line none">  109         c = zip(c, cp).map(|(a, b)| min(a, b)).collect();</div><div id="110" class="line none">  110     }</div><div id="111" class="line none">  111     Ok(c)</div><div id="112" class="line none">  112 }</div><div id="113" class="line none">  113 </div><div id="114" class="line none">  114 fn x_if(bits: &amp;[bool]) -&gt; <a href="main.rs.html#114">Vec</a>&lt;usize&gt; {</div><div id="115" class="line none">  115     let n = 2 * bits.len();</div><div id="116" class="line none">  116     (0..n)</div><div id="117" class="line none">  117         .map(|x| if bits[x &gt;&gt; 1] { x ^ 1 } else { x })</div><div id="118" class="line none">  118         .collect()</div><div id="119" class="line none">  119 }</div><div id="120" class="line none">  120 </div><div id="121" class="line none">  121 type <a href="main.rs.html#121">FlmDecomp</a> = (<a href="main.rs.html#114">Vec</a>&lt;bool&gt;, <a href="main.rs.html#114">Vec</a>&lt;usize&gt;, <a href="main.rs.html#114">Vec</a>&lt;bool&gt;);</div><div id="122" class="line none">  122 </div><div id="123" class="line none">  123 fn flm_decomp(pi: &amp;[usize]) -&gt; <a href="main.rs.html#7">Result</a>&lt;<a href="main.rs.html#121">FlmDecomp</a>, SimpleError&gt; {</div><div id="124" class="line none">  124     let <a href="main.rs.html#49">m</a> = get_permutation_exponent(pi)?;</div><div id="125" class="line none">  125     let c = cyclemin_pibar(pi)?;</div><div id="126" class="line none">  126     let f: <a href="main.rs.html#114">Vec</a>&lt;_&gt; = (0..(1 &lt;&lt; (<a href="main.rs.html#49">m</a> - 1))).map(|x| c[2 * x] % 2 == 1).collect();</div><div id="127" class="line none">  127     let f_perm = x_if(&amp;f);</div><div id="128" class="line none">  128     let piinv = composeinv(&amp;(0..(1 &lt;&lt; <a href="main.rs.html#49">m</a>)).collect::&lt;<a href="main.rs.html#114">Vec</a>&lt;_&gt;&gt;(), pi)?;</div><div id="129" class="line none">  129     let f_perm_pi = composeinv(&amp;f_perm, &amp;piinv)?;</div><div id="130" class="line none">  130     let l: <a href="main.rs.html#114">Vec</a>&lt;_&gt; = (0..(1 &lt;&lt; (<a href="main.rs.html#49">m</a> - 1)))</div><div id="131" class="line none">  131         .map(|x| f_perm_pi[2 * x] % 2 == 1)</div><div id="132" class="line none">  132         .collect();</div><div id="133" class="line none">  133     let l_perm = x_if(&amp;l);</div><div id="134" class="line none">  134     let m_perm = composeinv(&amp;f_perm_pi, &amp;l_perm)?;</div><div id="135" class="line none">  135     Ok((f, m_perm, l))</div><div id="136" class="line none">  136 }</div><div id="137" class="line none">  137 </div><div id="138" class="line none">  138 fn controlbits(pi_init: &amp;[usize]) -&gt; <a href="main.rs.html#7">Result</a>&lt;<a href="main.rs.html#114">Vec</a>&lt;bool&gt;, SimpleError&gt; {</div><div id="139" class="line none">  139     let m_init = get_permutation_exponent(pi_init)?;</div><div id="140" class="line none">  140     let mut control_bits: <a href="main.rs.html#114">Vec</a>&lt;bool&gt; = <a href="main.rs.html#114">Vec</a>::with_capacity((2 * m_init - 1) &lt;&lt; (m_init - 1));</div><div id="141" class="line none">  141     control_bits.resize((2 * m_init - 1) &lt;&lt; (m_init - 1), false);</div><div id="142" class="line none">  142     let mut stack: <a href="main.rs.html#114">Vec</a>&lt;(usize, <a href="main.rs.html#114">Vec</a>&lt;usize&gt;)&gt; = vec![(0, pi_init.to_vec())];</div><div id="143" class="line none">  143     while let Some((pos, pi_curr)) = stack.pop() {</div><div id="144" class="line none">  144         let m_curr = get_permutation_exponent(&amp;pi_curr)?;</div><div id="145" class="line none">  145         if 0 &lt; m_curr {</div><div id="146" class="line none">  146             let (first_bits, middle_perm, last_bits) = flm_decomp(&amp;pi_curr)?;</div><div id="147" class="line none">  147             control_bits</div><div id="148" class="line none">  148                 .iter_mut()</div><div id="149" class="line none">  149                 .skip(pos)</div><div id="150" class="line none">  150                 .step_by(1 &lt;&lt; (m_init - m_curr))</div><div id="151" class="line none">  151                 .take(1 &lt;&lt; (m_curr - 1))</div><div id="152" class="line none">  152                 .zip(first_bits.iter())</div><div id="153" class="line none">  153                 .for_each(|(a, &amp;b)| *a = b);</div><div id="154" class="line none">  154             control_bits</div><div id="155" class="line none">  155                 .iter_mut()</div><div id="156" class="line none">  156                 .skip(pos + ((m_curr - 1) &lt;&lt; m_init))</div><div id="157" class="line none">  157                 .step_by(1 &lt;&lt; (m_init - m_curr))</div><div id="158" class="line none">  158                 .take(1 &lt;&lt; (m_curr - 1))</div><div id="159" class="line none">  159                 .zip(last_bits.iter())</div><div id="160" class="line none">  160                 .for_each(|(a, &amp;b)| *a = b);</div><div id="161" class="line none">  161             let even_perm: <a href="main.rs.html#114">Vec</a>&lt;usize&gt; = middle_perm.iter().step_by(2).map(|&amp;x| x &gt;&gt; 1).collect();</div><div id="162" class="line none">  162             let odd_perm: <a href="main.rs.html#114">Vec</a>&lt;usize&gt; = middle_perm</div><div id="163" class="line none">  163                 .iter()</div><div id="164" class="line none">  164                 .skip(1)</div><div id="165" class="line none">  165                 .step_by(2)</div><div id="166" class="line none">  166                 .map(|&amp;x| x &gt;&gt; 1)</div><div id="167" class="line none">  167                 .collect();</div><div id="168" class="line none">  168             stack.push((pos + (1 &lt;&lt; (m_init - 1)), even_perm));</div><div id="169" class="line none">  169             stack.push((</div><div id="170" class="line none">  170                 pos + (1 &lt;&lt; (m_init - 1)) + (1 &lt;&lt; (m_init - m_curr)),</div><div id="171" class="line none">  171                 odd_perm,</div><div id="172" class="line none">  172             ));</div><div id="173" class="line none">  173         }</div><div id="174" class="line none">  174     }</div><div id="175" class="line none">  175     Ok(control_bits)</div><div id="176" class="line none">  176 }</div><div id="177" class="line none">  177 </div><div id="178" class="line none">  178 fn <a href="main.rs.html#178">main</a>() {</div><div id="179" class="line none">  179     let pi = vec![2, 3, 1, 0];</div><div id="180" class="line none">  180     println!("{pi:?}");</div><div id="181" class="line none">  181     if let Ok(c) = controlbits(&amp;pi) {</div><div id="182" class="line none">  182         println!("{c:?}");</div><div id="183" class="line none">  183         if let Ok(p2) = permutation(&amp;c) {</div><div id="184" class="line none">  184             println!("{p2:?}");</div><div id="185" class="line none">  185         }</div><div id="186" class="line none">  186     }</div><div id="187" class="line none">  187     let pi = vec![7, 13, 0, 2, 12, 1, 3, 14, 4, 10, 11, 5, 15, 6, 8, 9];</div><div id="188" class="line none">  188     println!("{pi:?}");</div><div id="189" class="line none">  189     if let Ok(c) = controlbits(&amp;pi) {</div><div id="190" class="line none">  190         println!("{c:?}");</div><div id="191" class="line none">  191         if let Ok(p2) = permutation(&amp;c) {</div><div id="192" class="line none">  192             println!("{p2:?}");</div><div id="193" class="line none">  193         }</div><div id="194" class="line none">  194     }</div><div id="195" class="line none">  195 }</div><div id="196" class="line none">  196 </div><div id="197" class="line none">  197 #[cfg(kani)]</div><div id="198" class="line none">  198 #[kani::proof]</div><div id="199" class="line none">  199 fn <a href="main.rs.html#199">check_estimate_size</a>() {</div><div id="200" class="line none">  200     let c: [usize; 2] = kani::any();</div><div id="201" class="line none">  201     let pi: [usize; 2] = kani::any();</div><div id="202" class="line none">  202     if let Ok(v) = composeinv(&amp;c, &amp;pi) {</div><div id="203" class="line none">  203         for i in 0..2 {</div><div id="204" class="line none">  204             assert!(v[i] == c[pi[i]]);</div><div id="205" class="line none">  205         }</div><div id="206" class="line none">  206     }</div><div id="207" class="line none">  207 }</div>
</div>
</body>
</html>
